<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simple Markdown Viewer</title>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <!-- MathJax for formulas -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>

  <style>
    :root{
      --bg: #ffffff;
      --fg: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
      --page-width: 780px;
      --shadow: 0 6px 18px rgba(16,24,40,0.06);
      --radius: 14px;
      --max-width: 900px;
    }

    /* Theme variants */
    body[data-theme='light']{ --bg:#ffffff; --fg:#0f172a; --muted:#6b7280; --accent:#2563eb; }
    body[data-theme='sepia']{ --bg:#f5ecd9; --fg:#3b2f2f; --muted:#7a6b5a; --accent:#b56b00; }
    body[data-theme='dark']{ --bg:#0d1117; --fg:#e6edf3; --muted:#8b949e; --accent:#58a6ff; }
    body[data-theme='midnight']{ --bg:#000000; --fg:#ffffff; --muted:#bbbbbb; --accent:#ff8c00; }
    body[data-theme='slate']{ --bg:#1e293b; --fg:#f1f5f9; --muted:#94a3b8; --accent:#38bdf8; }
    body[data-theme='calm']{ --bg:#f7fbfc; --fg:#153e4d; --muted:#5b6b74; --accent:#0ea5a4; }

    html,body{height:100%;}
    body{
      margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg); color:var(--fg); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex; align-items:flex-start; justify-content:center; padding:36px;
    }

    .app{ width:100%; max-width:var(--max-width); }
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:18px; }
    .controls{ display:flex; gap:8px; align-items:center; }

    .btn{
      background:rgba(255,255,255,0.08);
      color:var(--fg);
      border:1px solid var(--muted);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      box-shadow:var(--shadow);
    }

    .uploader{ display:flex; gap:8px; align-items:center; }

    .viewer{
      margin:0 auto; width:100%; max-width:var(--page-width);
      background: var(--bg);
      padding:36px; border-radius:var(--radius); box-shadow:var(--shadow);
    }

    /* Markdown styling */
    .viewer h1{ font-size:2rem; margin:0 0 8px; }
    .viewer h2{ font-size:1.5rem; margin-top:1.1rem; }
    .viewer h3{ font-size:1.15rem; }
    .viewer p{ line-height:1.6; color:var(--fg); }
    .viewer a{ color:var(--accent); text-decoration:none; }
    .viewer pre{ padding:14px; border-radius:10px; overflow:auto; background:rgba(0,0,0,0.04); }
    .viewer code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
    .viewer blockquote{ border-left:4px solid rgba(0,0,0,0.08); padding-left:12px; color:var(--muted); margin:12px 0; }
    .viewer ul, .viewer ol{ padding-left:1.05rem; }

    footer{ margin-top:12px; color:var(--muted); font-size:13px; display:flex; justify-content:space-between; }
    @media (max-width:640px){ body{padding:18px;} .viewer{padding:20px;} }
  </style>
</head>
<body data-theme="light">
  <div class="app">
    <header>
      <div style="display:flex; gap:12px; align-items:center;">
        <strong style="font-size:1.05rem">Markdown Viewer</strong>
        <span style="color:var(--muted); font-size:0.95rem">â€” drop a .md file or paste a URL</span>
      </div>

      <div class="controls">
        <div class="uploader">
          <label class="btn">Open .md
            <input id="fileInput" type="file" accept=".md,text/markdown,text/plain" style="display:none">
          </label>
          <button id="pasteBtn" class="btn">Paste markdown</button>
        </div>

        <select id="themeSelect" class="btn" style="background:rgba(255,255,255,0.12); color:var(--fg); border:1px solid var(--muted);">
          <option value="light">Light</option>
          <option value="sepia">Sepia</option>
          <option value="calm">Calm</option>
          <option value="dark">Dark</option>
          <option value="midnight">Midnight</option>
          <option value="slate">Slate</option>
        </select>
      </div>
    </header>

    <main>
      <article id="viewer" class="viewer">
        <h1 style="text-align:center; color:var(--muted);">No file loaded</h1>
        <p style="text-align:center; color:var(--muted);">Load a local .md file, paste markdown, or drag & drop a file onto the page.</p>
      </article>

      <footer>
        <div>Rendered with <a href="https://github.com/markedjs/marked">marked</a> & <a href="https://github.com/cure53/DOMPurify">DOMPurify</a></div>
        <div style="opacity:0.8">Theme: <span id="currentTheme">Light</span></div>
      </footer>
    </main>
  </div>

  <!-- Paste modal -->
  <div id="pasteModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center;">
    <div style="background:var(--bg); width:90%; max-width:760px; padding:18px; border-radius:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <strong>Paste Markdown</strong>
        <button id="pasteClose" class="btn">Close</button>
      </div>
      <textarea id="pasteArea" placeholder="# Paste markdown here" style="width:100%; height:300px; padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:transparent; color:var(--fg)"></textarea>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
        <button id="pasteRender" class="btn">Render</button>
      </div>
    </div>
  </div>

  <script>
  // --- Config ---
  marked.setOptions({ headerIds: true, mangle: false });

  // Elements
  const fileInput = document.getElementById('fileInput');
  const viewer = document.getElementById('viewer');
  const themeSelect = document.getElementById('themeSelect');
  const currentTheme = document.getElementById('currentTheme');

  function renderMarkdown(mdText){
    if(typeof mdText !== 'string') mdText = String(mdText || '');
    try{ localStorage.setItem('md_content', mdText); }catch(e){}

    const raw = marked.parse(mdText);
    const clean = DOMPurify.sanitize(raw, {ADD_ATTR: ['target']});
    viewer.innerHTML = clean;

    // highlight.js
    try{ document.querySelectorAll('pre code').forEach((el)=> hljs.highlightElement(el)); }catch(e){}
    // MathJax (if loaded)
    if(window.MathJax && typeof MathJax.typesetPromise === 'function'){
      MathJax.typesetPromise().catch(()=>{});
    }
  }

  // File open
  fileInput.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0]; if(!f) return;
    try{ const txt = await f.text(); renderMarkdown(txt); }catch(err){ console.error(err); }
  });

  // Drag & drop
  window.addEventListener('dragover', e=> e.preventDefault());
  window.addEventListener('drop', async (e)=>{
    e.preventDefault(); const f = e.dataTransfer?.files?.[0]; if(!f) return;
    try{ const txt = await f.text(); renderMarkdown(txt); }catch(err){ console.error(err); }
  });

  // Paste modal
  const pasteBtn = document.getElementById('pasteBtn');
  const pasteModal = document.getElementById('pasteModal');
  const pasteClose = document.getElementById('pasteClose');
  const pasteRender = document.getElementById('pasteRender');
  const pasteArea = document.getElementById('pasteArea');

  pasteBtn.addEventListener('click', ()=>{ pasteModal.style.display='flex'; pasteArea.value=''; pasteArea.focus(); });
  pasteClose.addEventListener('click', ()=> pasteModal.style.display='none');
  pasteRender.addEventListener('click', ()=>{ renderMarkdown(pasteArea.value); pasteModal.style.display='none'; });

  // Theme memory
  try{
    const savedTheme = localStorage.getItem('md_theme');
    if(savedTheme){ document.body.setAttribute('data-theme', savedTheme); themeSelect.value = savedTheme; currentTheme.textContent = savedTheme.charAt(0).toUpperCase() + savedTheme.slice(1); }
  }catch(e){}

  themeSelect.addEventListener('change', (e)=>{
    const t = e.target.value; document.body.setAttribute('data-theme', t); currentTheme.textContent = t.charAt(0).toUpperCase() + t.slice(1); try{ localStorage.setItem('md_theme', t); }catch(e){}
  });

  // Load saved markdown
  try{ const savedMD = localStorage.getItem('md_content'); if(savedMD) renderMarkdown(savedMD); }catch(e){}

  // Load from ?file=
  async function tryLoadFromQuery(){
    try{
      const params = new URLSearchParams(location.search);
      const url = params.get('file'); if(!url) return;
      const res = await fetch(url);
      if(res.ok){ const txt = await res.text(); renderMarkdown(txt); }
    }catch(e){ console.warn(e); }
  }
  tryLoadFromQuery();

  // Ctrl+O -> open file
  window.addEventListener('keydown', (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'o'){
      e.preventDefault(); fileInput.click();
    }
  });

  // Auto-load notes.md if present
  (async function(){ try{ const res = await fetch('./notes.md'); if(res.ok){ const txt = await res.text(); renderMarkdown(txt); } }catch(e){} })();
  </script>
</body>
</html>
